name: Deploy Backend

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to EC2
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            ensure_docker() {
              if command -v docker >/dev/null 2>&1; then
                return 0
              fi

              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y docker.io docker-compose-plugin
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y docker
              else
                echo "Docker is not available and cannot be installed automatically" >&2
                return 1
              fi

              sudo systemctl enable docker >/dev/null 2>&1 || true
              sudo systemctl start docker >/dev/null 2>&1 || true
            }

            start_db_with_compose() {
              if ! command -v docker >/dev/null 2>&1; then
                return 1
              fi

              if sudo docker compose -f /var/www/SunEdu/backend/docker-compose.yml up -d db >/dev/null 2>&1; then
                return 0
              fi

              if command -v docker-compose >/dev/null 2>&1 && \
                 sudo docker-compose -f /var/www/SunEdu/backend/docker-compose.yml up -d db >/dev/null 2>&1; then
                return 0
              fi

              return 1
            }

            ensure_fallback_container() {
              if ! command -v docker >/dev/null 2>&1; then
                return 1
              fi

              DB_VOLUME="/var/lib/sunedu-postgres"
              DB_CONTAINER="sunedu-postgres"
              sudo mkdir -p "${DB_VOLUME}"

              if sudo docker ps --format '{{.Names}}' | grep -Eq "^${DB_CONTAINER}$"; then
                return 0
              fi

              if sudo docker ps -a --format '{{.Names}}' | grep -Eq "^${DB_CONTAINER}$"; then
                sudo docker start "${DB_CONTAINER}" >/dev/null
                return 0
              fi

              sudo docker run -d --restart=always \
                -e POSTGRES_DB="${DB_NAME}" \
                -e POSTGRES_USER="${DB_USER}" \
                -e POSTGRES_PASSWORD="${DB_PASSWORD}" \
                -p "${DB_PORT}:5432" \
                -v "${DB_VOLUME}:/var/lib/postgresql/data" \
                --name "${DB_CONTAINER}" \
                postgres:15 >/dev/null
            }

            cd /var/www/SunEdu
            git fetch origin main
            git reset --hard origin/main

            VENV_PATH="/var/www/SunEdu/backend/.venv"
            rm -rf "${VENV_PATH}"
            python3 -m venv "${VENV_PATH}"

            PIP_CMD="${VENV_PATH}/bin/pip"
            PYTHON_CMD="${VENV_PATH}/bin/python"

            ENV_PATH="/var/www/SunEdu/backend/.env"
            if [ -f "${ENV_PATH}" ]; then
              DB_HOST=$(grep -E '^DB_HOST=' "${ENV_PATH}" | tail -n1 | cut -d= -f2- | tr -d '\r')
              DB_PORT=$(grep -E '^DB_PORT=' "${ENV_PATH}" | tail -n1 | cut -d= -f2- | tr -d '\r')
              DB_NAME=$(grep -E '^DB_NAME=' "${ENV_PATH}" | tail -n1 | cut -d= -f2- | tr -d '\r')
              DB_USER=$(grep -E '^DB_USER=' "${ENV_PATH}" | tail -n1 | cut -d= -f2- | tr -d '\r')
              DB_PASSWORD=$(grep -E '^DB_PASSWORD=' "${ENV_PATH}" | tail -n1 | cut -d= -f2- | tr -d '\r')
            fi
            DB_HOST=${DB_HOST:-127.0.0.1}
            DB_PORT=${DB_PORT:-5433}
            DB_NAME=${DB_NAME:-elearning}
            DB_USER=${DB_USER:-elearning}
            DB_PASSWORD=${DB_PASSWORD:-123456}
            export DB_HOST
            export DB_PORT

            # Ensure PostgreSQL container/service is running
            ensure_docker || true

            if ! start_db_with_compose; then
              if command -v systemctl >/dev/null 2>&1; then
                sudo systemctl start postgresql >/dev/null 2>&1 || true
                sudo systemctl start postgresql@15-main >/dev/null 2>&1 || true
                sudo systemctl start postgresql@14-main >/dev/null 2>&1 || true
              fi
              ensure_fallback_container || true
            fi

            if command -v pg_isready >/dev/null 2>&1; then
              DB_READY=0
              for i in $(seq 1 40); do
                if pg_isready -h "${DB_HOST}" -p "${DB_PORT}" >/dev/null 2>&1; then
                  DB_READY=1
                  break
                fi
                echo "Waiting for PostgreSQL on ${DB_HOST}:${DB_PORT} (attempt $i/40)..."
                sleep 3
              done
              if [ "${DB_READY}" -ne 1 ]; then
                echo "Database on ${DB_HOST}:${DB_PORT} did not become ready in time" >&2
                exit 1
              fi
            else
              DB_READY=0
              for i in $(seq 1 40); do
                if timeout 2 bash -c "cat < /dev/null > /dev/tcp/${DB_HOST}/${DB_PORT}" >/dev/null 2>&1; then
                  DB_READY=1
                  break
                fi
                echo "Waiting for PostgreSQL on ${DB_HOST}:${DB_PORT} (attempt $i/40)..."
                sleep 3
              done
              if [ "${DB_READY}" -ne 1 ]; then
                echo "Database on ${DB_HOST}:${DB_PORT} did not become ready in time" >&2
                exit 1
              fi
            fi

            cd backend
            "${PIP_CMD}" install --upgrade pip
            "${PIP_CMD}" install -r requirements.txt
            "${PYTHON_CMD}" manage.py migrate --noinput
            "${PYTHON_CMD}" manage.py collectstatic --noinput

            sudo systemctl restart sunedu-backend
            sudo systemctl restart sunedu-celery || true
