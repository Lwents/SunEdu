name: Deploy Backend

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to EC2
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            cd /var/www/SunEdu
            git fetch origin main
            git reset --hard origin/main

            VENV_PATH="/var/www/SunEdu/backend/.venv"
            rm -rf "${VENV_PATH}"
            python3 -m venv "${VENV_PATH}"

            PIP_CMD="${VENV_PATH}/bin/pip"
            PYTHON_CMD="${VENV_PATH}/bin/python"

            # Ensure PostgreSQL container/service is running
            if command -v docker >/dev/null 2>&1; then
              sudo docker compose -f /var/www/SunEdu/backend/docker-compose.yml up -d db >/dev/null 2>&1 || \
              sudo docker-compose -f /var/www/SunEdu/backend/docker-compose.yml up -d db
            fi

            if command -v systemctl >/dev/null 2>&1; then
              sudo systemctl start postgresql >/dev/null 2>&1 || true
            fi

            ENV_PATH="/var/www/SunEdu/backend/.env"
            if [ -f "${ENV_PATH}" ]; then
              DB_HOST=$(grep -E '^DB_HOST=' "${ENV_PATH}" | tail -n1 | cut -d= -f2 | tr -d '\r')
              DB_PORT=$(grep -E '^DB_PORT=' "${ENV_PATH}" | tail -n1 | cut -d= -f2 | tr -d '\r')
            fi
            DB_HOST=${DB_HOST:-127.0.0.1}
            DB_PORT=${DB_PORT:-5433}
            export DB_HOST
            export DB_PORT

            if command -v pg_isready >/dev/null 2>&1; then
              for i in {1..40}; do
                if pg_isready -h "${DB_HOST}" -p "${DB_PORT}" >/dev/null 2>&1; then
                  break
                fi
                sleep 3
              done
            else
              python3 - <<'PY'
                import socket
                import time
                import os

                host = os.environ.get("DB_HOST", "127.0.0.1")
                port = int(os.environ.get("DB_PORT", "5433"))

                for _ in range(40):
                    try:
                        with socket.create_connection((host, port), timeout=2):
                            break
                    except OSError:
                        time.sleep(3)
                else:
                    raise SystemExit(f"Database on {host}:{port} did not become ready in time")
              PY
            fi

            cd backend
            "${PIP_CMD}" install --upgrade pip
            "${PIP_CMD}" install -r requirements.txt
            "${PYTHON_CMD}" manage.py migrate --noinput
            "${PYTHON_CMD}" manage.py collectstatic --noinput

            sudo systemctl restart sunedu-backend
            sudo systemctl restart sunedu-celery || true
